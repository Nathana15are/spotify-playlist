<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Playlist Spotify Automatique</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 8px; border: none; background: #1DB954; color: white; }
    input { padding: 8px; width: 300px; margin: 5px; }
    #status { margin-top: 20px; font-weight: bold; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Cr√©er une Playlist Spotify üé∂</h1>
  
  <button id="login">Connexion √† Spotify</button><br><br>
  
  <input type="text" id="artist" placeholder="Nom de l'artiste">
  <button id="create">Cr√©er la playlist</button>

  <p id="status"></p>

  <script>
    // ‚ö†Ô∏è Mets ton vrai client_id ici (pas le secret !)
    const clientId = "4010e6bc0769401998470933049308ea"; 
    const redirectUri = window.location.origin + window.location.pathname; 
    const scopes = "playlist-modify-public playlist-modify-private";
    let accessToken = null;

    function showError(msg) {
      document.getElementById("status").innerHTML = `<span class="error">‚ùå ${msg}</span>`;
    }

    // Connexion
    document.getElementById("login").onclick = () => {
      if (!clientId || clientId === "4010e6bc0769401998470933049308ea") {
        showError("Tu dois d‚Äôabord mettre ton vrai Client ID Spotify dans le code !");
        return;
      }
      const url = "https://accounts.spotify.com/authorize" +
        "?response_type=token" +
        "&client_id=" + encodeURIComponent(clientId) +
        "&scope=" + encodeURIComponent(scopes) +
        "&redirect_uri=" + encodeURIComponent(redirectUri);
      window.location = url;
    };

    // R√©cup√©ration du token
    window.onload = () => {
      if (window.location.hash) {
        const params = new URLSearchParams(window.location.hash.substring(1));
        if (params.get("error")) {
          // Si Spotify renvoie une erreur
          showError(`Erreur Spotify : ${params.get("error")}. V√©rifie ton Client ID et ton Redirect URI dans le dashboard.`);
          return;
        }
        accessToken = params.get("access_token");
        if (accessToken) {
          document.getElementById("status").innerText = "‚úÖ Connect√© √† Spotify";
        }
      }
    };

    // Cr√©ation playlist
    document.getElementById("create").onclick = async () => {
      if (!accessToken) return showError("Connecte-toi d'abord !");
      const artistName = document.getElementById("artist").value;
      if (!artistName) return showError("Tape un artiste !");
      
      const headers = { Authorization: "Bearer " + accessToken };

      try {
        // 1. Profil utilisateur
        let res = await fetch("https://api.spotify.com/v1/me", { headers });
        if (!res.ok) throw new Error("Impossible de r√©cup√©rer ton profil (token invalide ?)");
        const me = await res.json();

        // 2. Trouver l‚Äôartiste
        res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`, { headers });
        const search = await res.json();
        const artist = search.artists.items[0];
        if (!artist) return showError("Artiste introuvable !");
        
        // 3. Top tracks
        res = await fetch(`https://api.spotify.com/v1/artists/${artist.id}/top-tracks?market=FR`, { headers });
        const tracks = (await res.json()).tracks.map(t => t.uri);

        // 4. Cr√©er playlist
        res = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ 
            name: `Playlist ${artist.name}`, 
            description: `Top titres de ${artist.name}`, 
            public: true 
          })
        });
        const playlist = await res.json();

        // 5. Ajouter morceaux
        await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ uris: tracks })
        });

        document.getElementById("status").innerHTML =
          `üéâ Playlist <b>${playlist.name}</b> cr√©√©e avec ${tracks.length} morceaux !<br>` +
          `<a href="${playlist.external_urls.spotify}" target="_blank">Ouvrir sur Spotify</a>`;
      } catch (err) {
        showError(err.message);
      }
    };
  </script>
</body>
</html>
