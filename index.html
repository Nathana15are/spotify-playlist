<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Spotify Playlist Debug</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 8px; border: none; background: #1DB954; color: white; }
    input { padding: 8px; width: 300px; margin: 5px; }
    #status { margin-top: 20px; font-weight: bold; }
    .error { color: red; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Spotify Playlist Debug üõ†Ô∏è</h1>

  <button id="login">Connexion √† Spotify</button><br><br>

  <input type="text" id="artist" placeholder="Nom de l'artiste">
  <button id="create">Cr√©er la playlist</button>

  <div id="status"></div>
  <h3>Debug Info:</h3>
  <pre id="debug"></pre>

  <script>
    const clientId = "4010e6bc0769401998470933049308ea"; // üîë Mets ton vrai Client ID
    const redirectUri = window.location.origin + window.location.pathname;
    const scopes = "playlist-modify-public playlist-modify-private";
    let accessToken = null;

    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");

    function logDebug(msg) {
      debugEl.textContent += msg + "\n";
      console.log(msg);
    }

    function showError(msg) {
      statusEl.innerHTML = `<span class="error">‚ùå ${msg}</span>`;
      logDebug(msg);
    }

    // Connexion Spotify
    document.getElementById("login").onclick = () => {
      if (!clientId || clientId === "4010e6bc0769401998470933049308ea") {
        showError("‚ö†Ô∏è Mets ton vrai Client ID dans le code !");
        return;
      }
      const authUrl = "https://accounts.spotify.com/authorize" +
        "?response_type=token" +
        "&client_id=" + encodeURIComponent(clientId) +
        "&scope=" + encodeURIComponent(scopes) +
        "&redirect_uri=" + encodeURIComponent(redirectUri);

      logDebug("URL de connexion g√©n√©r√©e :\n" + authUrl);
      window.location = authUrl;
    };

    // R√©cup√©ration du token
    window.onload = () => {
      if (window.location.hash) {
        const params = Object.fromEntries(new URLSearchParams(window.location.hash.substring(1)));
        if (params.error) {
          showError(`Erreur Spotify : ${params.error}. V√©rifie Client ID et Redirect URI.`);
          return;
        }
        accessToken = params.access_token;
        if (accessToken) {
          statusEl.textContent = "‚úÖ Connect√© √† Spotify";
          logDebug("Token r√©cup√©r√© : " + accessToken);
        }
      }
    };

    // Cr√©ation playlist
    document.getElementById("create").onclick = async () => {
      if (!accessToken) return showError("Connecte-toi d'abord !");
      const artistName = document.getElementById("artist").value;
      if (!artistName) return showError("Tape un artiste !");

      const headers = { Authorization: "Bearer " + accessToken };

      try {
        logDebug("R√©cup√©ration du profil utilisateur...");
        let res = await fetch("https://api.spotify.com/v1/me", { headers });
        if (!res.ok) throw new Error("Impossible de r√©cup√©rer ton profil (token invalide ?)");
        const me = await res.json();
        logDebug("Utilisateur : " + me.id);

        logDebug("Recherche de l'artiste : " + artistName);
        res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`, { headers });
        const search = await res.json();
        logDebug("R√©sultat recherche artiste : " + JSON.stringify(search.artists.items[0], null, 2));
        const artist = search.artists.items[0];
        if (!artist) return showError("Artiste introuvable !");

        logDebug("R√©cup√©ration top tracks...");
        res = await fetch(`https://api.spotify.com/v1/artists/${artist.id}/top-tracks?market=FR`, { headers });
        const tracks = (await res.json()).tracks.map(t => t.uri);
        logDebug("Tracks trouv√©s : " + tracks.join(", "));

        logDebug("Cr√©ation de la playlist...");
        res = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ 
            name: `Playlist ${artist.name}`, 
            description: `Top titres de ${artist.name}`, 
            public: true 
          })
        });
        const playlist = await res.json();
        logDebug("Playlist cr√©√©e : " + JSON.stringify(playlist, null, 2));

        logDebug("Ajout des morceaux...");
        await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ uris: tracks })
        });

        statusEl.innerHTML = `üéâ Playlist <b>${playlist.name}</b> cr√©√©e avec ${tracks.length} morceaux !<br>` +
          `<a href="${playlist.external_urls.spotify}" target="_blank">Ouvrir sur Spotify</a>`;
      } catch (err) {
        showError(err.message);
      }
    };
  </script>
</body>
</html>
