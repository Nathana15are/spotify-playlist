<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Spotify PKCE Playlist</title>
<style>
body{font-family:Arial;text-align:center;margin:50px}input,button{padding:10px;margin:5px;width:80%}button{background:#1DB954;color:#fff;border:none;border-radius:8px;cursor:pointer}#status{margin-top:20px;font-weight:bold}
</style>
</head>
<body>
<h1>Spotify PKCE Playlist ðŸŽ¶</h1>
<input type="text" id="clientId" placeholder="Client ID Spotify"><br>
<input type="text" id="artist" placeholder="Nom de l'artiste"><br>
<button id="go">Se connecter et crÃ©er playlist</button>
<div id="status"></div>
<script>
// ==== Helpers PKCE ====
function base64urlencode(str){return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(plain){const encoder=new TextEncoder();const data=encoder.encode(plain);return crypto.subtle.digest('SHA-256',data);}
async function generateChallenge(verifier){const hashed=await sha256(verifier);let str='';const arr=new Uint8Array(hashed);for(let b of arr){str+=String.fromCharCode(b);}return base64urlencode(str);}

// ==== Main ====
const go=document.getElementById("go"),status=document.getElementById("status");
const redirectUri=window.location.origin+window.location.pathname;

go.onclick=async()=>{
  const clientId=document.getElementById("clientId").value.trim();
  const artist=document.getElementById("artist").value.trim();
  if(!clientId||!artist){alert("Remplis Client ID et artiste !");return;}

  // Si on a dÃ©jÃ  un code dans l'URL, Ã©changer contre token
  const params=new URLSearchParams(window.location.search);
  if(params.has("code")&&localStorage.getItem("pkce_verifier")){
    const code=params.get("code");
    const verifier=localStorage.getItem("pkce_verifier");
    const tokenRes=await fetch("https://accounts.spotify.com/api/token",{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:new URLSearchParams({
        client_id:clientId,
        grant_type:"authorization_code",
        code:code,
        redirect_uri:redirectUri,
        code_verifier:verifier
      })
    });
    const tokenData=await tokenRes.json();
    if(tokenData.access_token){
      localStorage.removeItem("pkce_verifier");
      status.innerText="âœ… ConnectÃ© ! CrÃ©ation de playlist...";
      createPlaylist(tokenData.access_token,artist,clientId);
    } else {alert("Erreur token: "+JSON.stringify(tokenData));}
    return;
  }

  // GÃ©nÃ©ration verifier/challenge
  const verifier=Math.random().toString(36).substring(2,128);
  localStorage.setItem("pkce_verifier",verifier);
  const challenge=await generateChallenge(verifier);

  // Redirection vers Spotify
  const authUrl="https://accounts.spotify.com/authorize?response_type=code"+
    "&client_id="+encodeURIComponent(clientId)+
    "&scope="+encodeURIComponent("playlist-modify-public playlist-modify-private")+
    "&redirect_uri="+encodeURIComponent(redirectUri)+
    "&code_challenge_method=S256"+
    "&code_challenge="+encodeURIComponent(challenge);
  window.location=authUrl;
};

// ==== Fonction crÃ©ation playlist ====
async function createPlaylist(token,artist,clientId){
  try{
    const headers={Authorization:"Bearer "+token,"Content-Type":"application/json"};
    let res=await fetch("https://api.spotify.com/v1/me",{headers});
    const me=await res.json();

    res=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artist)}&type=artist&limit=1`,{headers});
    const a=(await res.json()).artists.items[0];
    if(!a){alert("Artiste introuvable");return;}

    res=await fetch(`https://api.spotify.com/v1/artists/${a.id}/top-tracks?market=FR`,{headers});
    const tracks=(await res.json()).tracks.map(t=>t.uri);

    res=await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`,{
      method:"POST",headers,body:JSON.stringify({name:`Playlist ${a.name}`,public:true})
    });
    const playlist=await res.json();

    await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`,{
      method:"POST",headers,body:JSON.stringify({uris:tracks})
    });

    status.innerHTML=`ðŸŽ‰ Playlist <b>${playlist.name}</b> crÃ©Ã©e !<br><a href="${playlist.external_urls.spotify}" target="_blank">Ouvrir sur Spotify</a>`;
  } catch(e){alert("Erreur: "+e.message);}
}
</script>
</body>
</html>


