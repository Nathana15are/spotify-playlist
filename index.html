<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Spotify PKCE Debug avec Erreur D√©taill√©e</title>
<style>
body{font-family:Arial;text-align:center;margin:50px;position:relative;overflow:hidden;}
input,button{padding:10px;margin:5px;width:80%;}
button{background:#1DB954;color:#fff;border:none;border-radius:8px;cursor:pointer;}
#status{margin-top:20px;font-weight:bold;font-size:18px;text-align:left;white-space:pre-line;}
.success{color:green;}
#check{display:none; font-size:50px; color:green;}
#reset{display:none;background:#f39c12;}
</style>
</head>
<body>
<h1>Spotify PKCE Debug + Erreurs D√©taill√©es üé∂</h1>
<input type="text" id="clientId" placeholder="Client ID Spotify"><br>
<input type="text" id="artist" placeholder="Nom de l'artiste"><br>
<button id="go">Se connecter et cr√©er playlist</button>
<div id="status"></div>
<div id="check">‚úîÔ∏è</div>
<button id="reset">Cr√©er une autre playlist</button>

<script>
function base64urlencode(str){return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(plain){const encoder=new TextEncoder();const data=encoder.encode(plain);return crypto.subtle.digest('SHA-256',data);}
async function generateChallenge(verifier){const hashed=await sha256(verifier);let str='';const arr=new Uint8Array(hashed);for(let b of arr){str+=String.fromCharCode(b);}return base64urlencode(str);}

const go=document.getElementById("go"),
      status=document.getElementById("status"),
      reset=document.getElementById("reset"),
      check=document.getElementById("check");
const redirectUri=window.location.origin+window.location.pathname;

// R√©cup√©ration automatique du ClientID
const savedClientId = localStorage.getItem("spotify_client_id");
if(savedClientId) document.getElementById("clientId").value = savedClientId;

async function handleAuthFlow(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  const clientId=document.getElementById("clientId").value.trim();
  const artist=document.getElementById("artist").value.trim();
  const verifier=localStorage.getItem("pkce_verifier");

  if(!clientId){status.innerText="‚ùå Client ID manquant !"; return;}
  localStorage.setItem("spotify_client_id", clientId);
  if(!code){status.innerText="‚ö†Ô∏è Aucun code re√ßu. Cliquez sur le bouton."; return;}
  if(!verifier){status.innerText="‚ùå Code verifier manquant ! Cliquez sur le bouton."; return;}

  status.innerText="üîë √âchange du code contre token...";
  try {
    const bodyData = new URLSearchParams({
      client_id: clientId,
      grant_type: "authorization_code",
      code: code,
      redirect_uri: redirectUri,
      code_verifier: verifier
    });
    const tokenRes = await fetch("https://accounts.spotify.com/api/token", {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body: bodyData
    });
    const tokenData = await tokenRes.json();

    if(tokenData.access_token){
      localStorage.removeItem("pkce_verifier");
      status.innerText="‚úÖ Connect√© ! Cr√©ation de playlist...";
      await createPlaylist(tokenData.access_token, artist);
      window.history.replaceState({}, document.title, redirectUri);
    } else {
      let errorMsg="‚ùå √âchec du token !\n";
      if(tokenData.error==="invalid_client") errorMsg+="‚û° Client ID incorrect\n";
      else if(tokenData.error==="invalid_grant") errorMsg+="‚û° Code verifier ou Redirect URI incorrect\n";
      else errorMsg+=`‚û° ${tokenData.error}: ${tokenData.error_description || "d√©tails non disponibles"}`;
      status.innerText=errorMsg;
      console.error("Token error detail:", tokenData);
    }
  } catch(e){status.innerText="‚ùå Erreur r√©seau : "+e.message;}
}

// Cr√©ation playlist simple
async function createPlaylist(token,artist){
  try{
    const headers={Authorization:"Bearer "+token,"Content-Type":"application/json"};
    let res=await fetch("https://api.spotify.com/v1/me",{headers});
    const me=await res.json();
    res=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artist)}&type=artist&limit=1`,{headers});
    const a=(await res.json()).artists.items[0]; if(!a){status.innerText="‚ùå Artiste introuvable";return;}
    res=await fetch(`https://api.spotify.com/v1/artists/${a.id}/top-tracks?market=FR`,{headers});
    const tracks=(await res.json()).tracks.map(t=>t.uri);
    res=await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`,{
      method:"POST",headers,body:JSON.stringify({name:`Playlist ${a.name}`,public:true})
    });
    const playlist=await res.json();
    await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`,{
      method:"POST",headers,body:JSON.stringify({uris:tracks})
    });
    status.innerHTML=`‚úÖ Playlist <b>${playlist.name}</b> cr√©√©e !<br><a href="${playlist.external_urls.spotify}" target="_blank">Ouvrir sur Spotify</a>`;
    check.style.display="inline-block";
    reset.style.display="inline-block";
  } catch(e){status.innerText="‚ùå Erreur : "+e.message;}
}

// Boutons
go.onclick=async()=>{
  const clientId=document.getElementById("clientId").value.trim();
  const artist=document.getElementById("artist").value.trim();
  if(!clientId||!artist){alert("Remplis Client ID et artiste !");return;}
  localStorage.setItem("spotify_client_id", clientId);
  const verifier=Math.random().toString(36).substring(2,128);
  localStorage.setItem("pkce_verifier",verifier);
  const challenge=await generateChallenge(verifier);
  const authUrl="https://accounts.spotify.com/authorize?response_type=code"+
    "&client_id="+encodeURIComponent(clientId)+
    "&scope="+encodeURIComponent("playlist-modify-public playlist-modify-private")+
    "&redirect_uri="+encodeURIComponent(redirectUri)+
    "&code_challenge_method=S256"+
    "&code_challenge="+encodeURIComponent(challenge);
  window.location=authUrl;
};
reset.onclick=()=>{document.getElementById("artist").value="";status.innerText="";check.style.display="none";reset.style.display="none";};
window.onload=handleAuthFlow;
</script>
</body>
</html>

