<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Spotify One-Click Playlist</title>
  <style>
    body { font-family: Arial; max-width: 500px; margin: 50px auto; text-align: center; }
    input, button { padding: 10px; margin: 5px; width: 80%; }
    button { background: #1DB954; color: white; border: none; border-radius: 8px; cursor: pointer; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Spotify One-Click Playlist ðŸŽ¶</h1>
  <input type="text" id="clientId" placeholder="Ton Client ID"><br>
  <input type="text" id="artist" placeholder="Nom de l'artiste"><br>
  <button id="go">CrÃ©er la playlist</button>
  <div id="status"></div>

  <script>
    const goBtn = document.getElementById("go");
    const statusEl = document.getElementById("status");
    const redirectUri = window.location.origin + window.location.pathname;
    const scopes = "playlist-modify-public playlist-modify-private";

    function getAccessToken() {
      if (window.location.hash) {
        const params = Object.fromEntries(new URLSearchParams(window.location.hash.substring(1)));
        if (params.access_token) return params.access_token;
      }
      return null;
    }

    goBtn.onclick = async () => {
      const clientId = document.getElementById("clientId").value.trim();
      const artistName = document.getElementById("artist").value.trim();
      if (!clientId || !artistName) { alert("Remplis Client ID et artiste !"); return; }

      let token = getAccessToken();
      if (!token) {
        // Redirige pour obtenir le token
        const url = "https://accounts.spotify.com/authorize" +
          "?response_type=token" +
          "&client_id=" + encodeURIComponent(clientId) +
          "&scope=" + encodeURIComponent(scopes) +
          "&redirect_uri=" + encodeURIComponent(redirectUri);
        window.location = url;
        return;
      }

      const headers = { Authorization: "Bearer " + token };

      try {
        // Profil utilisateur
        let res = await fetch("https://api.spotify.com/v1/me", { headers });
        const me = await res.json();

        // Recherche artiste
        res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`, { headers });
        const artist = (await res.json()).artists.items[0];
        if (!artist) { alert("Artiste introuvable !"); return; }

        // Top tracks
        res = await fetch(`https://api.spotify.com/v1/artists/${artist.id}/top-tracks?market=FR`, { headers });
        const tracks = (await res.json()).tracks.map(t => t.uri);

        // CrÃ©er playlist
        res = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ name: `Playlist ${artist.name}`, public: true })
        });
        const playlist = await res.json();

        // Ajouter morceaux
        await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
          method: "POST",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ uris: tracks })
        });

        statusEl.innerHTML = `ðŸŽ‰ Playlist <b>${playlist.name}</b> crÃ©Ã©e !<br>` +
          `<a href="${playlist.external_urls.spotify}" target="_blank">Ouvrir sur Spotify</a>`;
      } catch (err) {
        alert("Erreur : " + err.message);
      }
    };
  </script>
</body>
</html>
